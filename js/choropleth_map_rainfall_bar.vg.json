{
	"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
	
	"params": [
		{
			"name": "selected_year",
			"value": 2014,
			"bind": {
				"input": "range",
				"min": 2014,
				"max": 2020,
				"step": 1,
				"name": "Select Year: "
			}
		}
	],
	"config": {
				"title": {
					"fontSize": 16,
					"font": "Open Sans",
					"fontWeight":"normal"
				}
			},
	"vconcat": [
		{
			"title": "Floods in Malaysia (2000 - 2024)",
			
			"width":750,
			"height": 300,
			"projection": {
				"type": "mercator",
				"center": [109.5,8],
				"scale": 2150
			},
			"layer": [
				{
					"data": {
						"graticule": {
							"step": [3,3]
						}
					},
					"mark": {
						"type": "geoshape",
						"stroke": "lightgray",
						"fill": "none"
					}
				},
				{
					"data": {
						"url": "https://raw.githubusercontent.com/picolloo/Assignment-2/main/js/ne_10m_admin_0_countries.json",
						"format": {
							"type": "topojson",
							"feature": "ne_10m_admin_0_countries"
						}
					},
					"mark": {
						"type": "geoshape",
						"fill": "#E0E0E0",
						"stroke": "white",
						"strokeWidth": 0.4
					}
				},
				{
					"params": [
						{
							"name": "selected_state",
							"select": {
								"type": "point",
								"fields": ["state_name"],
								"on": "click"
							}
						}
					],
					"data": {
						"url": "https://raw.githubusercontent.com/picolloo/Assignment-2/main/js/ne_10m_admin_1_states_provinces.json",
						"format": {
							"type": "topojson",
							"feature": "ne_10m_admin_1_states_provinces"
						}
					},
					"transform": [
						{
							"calculate": "datum['properties.name']",
							"as": "state_name"
						},
						{
							"lookup": "properties.name",
							"from": {
								"data": {
									"url": "https://raw.githubusercontent.com/picolloo/Assignment-2/main/data/flood_dataset.csv"
								},
								"key": "STATE",
								"fields": ["FLOOD"]
							}
						},
						{
							"calculate": "toNumber(datum.FLOOD)",
							"as": "FLOOD_NUM"
						},
						{
							"joinaggregate": [
								{
									"op": "max",
									"field": "FLOOD_NUM",
									"as": "MAX_FLOOD"
								}
							]
						},
						{
							"calculate": "datum.FLOOD_NUM / datum.MAX_FLOOD",
							"as": "FLOOD_NORM"
						}
					],
					"mark": {
						"type": "geoshape",
						"stroke": "white"
					},
					"encoding": {
						"color": {
							"field": "FLOOD_NORM",
							"type": "quantitative",
							"scale": {
								"scheme": "blues"
							},
							"legend": {
								"title": "Relative Flood Frequency",
								"orient": "bottom"
							}
						},
						"opacity": {
							"condition": {
								"param": "selected_state",
								"value": 1
							},
							"value": 0.1
						},
						"tooltip": [
							{
								"field": "properties.name",
								"title": "State"
							},
							{
								"field": "FLOOD_NUM",
								"title": "Total Floods"
							},
							{
								"field": "FLOOD_NORM",
								"title": "Relative Flood Frequency",
								"format": ".2f"
							}
						]
					}
				}
			]
		},
		{
			"title": {
				"text": {
					"expr": "selected_state.state_name && selected_state.state_name.length ? 'Monthly Total Rainfall in Year ' + selected_year + ' (' + selected_state.state_name[0] + ')': 'Monthly Total Rainfall in Year ' + selected_year + ' (Johor)'"
				}
			},
			"width": 750,
			"height": 300,
			"data": {
				"url": "https://raw.githubusercontent.com/picolloo/Assignment-2/main/data/rainfall.csv"
			},
			"transform": [
				{
					"filter": "selected_state.state_name && selected_state.state_name.length ? datum.State == selected_state.state_name[0] : datum.State == 'Johor'"
				},
				{
					"filter": "datum.Year == selected_year"
				},
				{
					"calculate": "toNumber(datum['Average Rainfall'])",
					"as": "avg_rain"
				},
				{
					"calculate": "toNumber(datum['Total Rainfall'])",
					"as": "total_rain"
				}
			],
			"layer": [
				{
					"mark": {
						"type": "bar",
						"color": "#7ABFFF"
					},
					"encoding": {
						"x": {
							"field": "Month",
							"type": "ordinal",
							"scale": {
								"domain": ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
							},
							"axis": {
                        "labelAngle": -45
                    }
						},
						"y": {
							"field": "total_rain",
							"type": "quantitative",
							"title": "Total Rainfall (mm)"
						},
						"tooltip": [
							{
								"field": "State",
								"title": "State"
							},
							{
								"field": "Year",
								"title": "Year"
							},
							{
								"field": "Month",
								"title": "Month"
							},
							{
								"field": "total_rain",
								"title": "Total Rainfall (mm)"
							},
							{
								"field": "avg_rain",
								"title": "Average Daily Rainfall (mm)"
							}
						]
					}
				},
				{
					"data": {
						"values": [
							{
								"Month": "November"
							},
							{
								"Month": "March"
							}
						]
					},
					"mark": {
						"type": "rule",
						"color": "#F54927",
						"strokeDash": [5, 5],
						"strokeWidth": 2
					},
					"encoding": {
						"x": {
							"field": "Month",
							"type": "nominal"
						}
					}
				},
				{
					"data": {
						"values": [
							{
								"Month": "November",
								"label": "Northeast Monsoon Start"
							},
							{
								"Month": "March",
								"label": "Northeast Monsoon End"
							}
						]
					},
					"mark": {
						"type": "text",
						"dy": -15,
						"color": "#F54927",
						"fontWeight": 600
					},
					"encoding": {
						"x": {
							"field": "Month",
							"type": "nominal"
						},
						"y": {
							"value": 0
						},
						"text": {
							"field": "label"
						}
					}
				},
				{
					"transform": [
						{
							"joinaggregate": [
								{
									"op": "max",
									"field": "total_rain",
									"as": "max_rain"
								}
							]
						},
						{
							"filter": "datum.total_rain == datum.max_rain"
						},
						{
							"calculate": "'Highest: ' + format(datum.total_rain, '.2f') + ' mm'",
							"as": "label"
						}
					],
					"mark": {
						"type": "text",
						"dy": -6,
						"color": "black",
						"fontWeight": "bold"
					},
					"encoding": {
						"x": {
							"field": "Month",
							"type": "ordinal"
						},
						"y": {
							"field": "total_rain",
							"type": "quantitative"
						},
						"text": {
							"field": "label"
						}
					}
				},
				{
					"transform": [
						{
							"joinaggregate": [
								{
									"op": "min",
									"field": "total_rain",
									"as": "min_rain"
								}
							]
						},
						{
							"filter": "datum.total_rain == datum.min_rain"
						},
						{
							"calculate": "'Lowest: ' + format(datum.total_rain, '.2f') + ' mm'",
							"as": "label"
						}
					],
					"mark": {
						"type": "text",
						"dy": -8,
						"color": "black",
						"fontWeight": "bold"
					},
					"encoding": {
						"x": {
							"field": "Month",
							"type": "ordinal"
						},
						"y": {
							"field": "total_rain",
							"type": "quantitative"
						},
						"text": {
							"field": "label"
						}
					}
				}
			]
		}
	],
	"resolve": {
		"legend": {
			"color": "independent"
		}
	}
}